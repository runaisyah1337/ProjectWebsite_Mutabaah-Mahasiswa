<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekapan Aktivitas - STMIK Tazkia</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        body { background: #f4f7fe; margin: 0; padding: 0; font-family: 'Inter', sans-serif; display: flex; justify-content: center; }
        .recap-container { width: 100%; max-width: 850px; padding: 30px 20px; box-sizing: border-box; }
        
        /* BANNER */
        .recap-banner { background: linear-gradient(135deg, #003399 0%, #0056b3 100%); padding: 30px; border-radius: 20px; color: white; text-align: center; margin-bottom: 25px; box-shadow: 0 10px 25px rgba(0, 51, 153, 0.1); }
        
        /* SUMMARY CARD (KHUSUS PEMBINA) */
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .summary-card { background: white; padding: 15px; border-radius: 15px; text-align: center; border: 1px solid #edf2f7; }
        .summary-card i { font-size: 20px; margin-bottom: 8px; display: block; }
        .summary-card h5 { margin: 0; font-size: 11px; color: #888; text-transform: uppercase; }
        .summary-card p { margin: 5px 0 0; font-size: 16px; font-weight: bold; color: #333; }

        /* ALERT BOX */
        .alert-recommendation { background: #fff5f5; border-left: 5px solid #feb2b2; padding: 12px 18px; border-radius: 12px; margin-bottom: 25px; display: none; }
        .alert-recommendation h4 { margin: 0 0 5px; color: #c53030; font-size: 13px; }
        .alert-recommendation p { margin: 0; font-size: 12px; color: #742a2a; }

        /* TIMELINE RAMPING */
        .timeline { position: relative; padding-left: 20px; }
        .timeline::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background: #cbd5e1; border-radius: 4px; }
        .timeline-item { position: relative; margin-bottom: 12px; }
        .timeline-dot { position: absolute; left: -25px; top: 14px; width: 8px; height: 8px; background: white; border: 2px solid #003399; border-radius: 50%; z-index: 2; }
        
        .timeline-card { 
            background: white; 
            padding: 10px 18px; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); 
            border: 1px solid #edf2f7; 
        }

        .item-info { display: flex; align-items: center; gap: 12px; }
        .item-icon { width: 35px; height: 35px; background: #f0f7ff; color: #003399; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 15px; }
        
        .score-display { display: flex; align-items: center; gap: 10px; text-align: right; }
        .badge-score { padding: 4px 10px; border-radius: 5px; font-weight: 800; font-size: 9px; text-transform: uppercase; }
        .score-desc { font-size: 11px; color: #888; font-weight: 500; }

        .score-3 { background: #dcfce7; color: #16a34a; }
        .score-2 { background: #fef9c3; color: #ca8a04; }
        .score-1 { background: #fee2e2; color: #dc2626; }

        .nav-footer { text-align: center; margin-top: 30px; padding-bottom: 30px; }
        /* --- EFEK INTERAKTIF (NGEGEMBUNG) --- */
.timeline-card { 
    background: white; 
    padding: 10px 18px; 
    border-radius: 12px; 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.03); 
    border: 1px solid #edf2f7; 
    
    /* Tambahkan baris di bawah ini agar gerakannya halus */
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
    cursor: pointer;
}

/* Saat disentuh (Hover) */
.timeline-card:hover { 
    transform: scale(1.01); /* Ngegembung sedikit */
    box-shadow: 0 8px 15px rgba(0, 51, 153, 0.1); /* Bayangan lebih halus */
    z-index: 5; /* Agar tidak tertutup item lain saat membesar */
}

/* Tambahan: Efek pada kartu ringkasan pembina juga biar lucu */
.summary-card {
    background: white; 
    padding: 15px; 
    border-radius: 15px; 
    text-align: center; 
    border: 1px solid #edf2f7;
    transition: all 0.3s ease;
}

.summary-card:hover {
    transform: translateY(-2px); /* Melayang sedikit ke atas */
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
}
    </style>
</head>
<body>

<div class="recap-container">
    <div class="recap-banner">
        <h2 id="weekTitle" style="margin: 0; font-size: 22px;">Rekapan Mingguan</h2>
        <p id="studentName" style="font-size: 13px; opacity: 0.9; margin-top: 8px;">Memuat...</p>
    </div>

    <div class="summary-grid" id="summarySection" style="display: none;">
        <div class="summary-card">
            <i class="fas fa-star" style="color: #ffc107;"></i>
            <h5>Skor</h5>
            <p id="totalScoreText">0/27</p>
        </div>
        <div class="summary-card">
            <i class="fas fa-chart-line" style="color: #3b82f6;"></i>
            <h5>Persentase</h5>
            <p id="percentText">0%</p>
        </div>
        <div class="summary-card">
            <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>
            <h5>Terendah</h5>
            <p id="lowAmalanText">-</p>
        </div>
    </div>

    <div class="alert-recommendation" id="alertBox">
        <h4><i class="fas fa-comment-medical"></i> Catatan untuk Pembina:</h4>
        <p id="alertMessage"></p>
    </div>

    <div class="timeline" id="timelineContent"></div>

    <div class="nav-footer">
        <a href="javascript:void(0)" onclick="goBack()" style="text-decoration: none; color: #64748b; font-size: 12px; font-weight: bold;">
            <i class="fas fa-arrow-left"></i> KEMBALI
        </a>
    </div>
</div>

<script>
    function getWeekOfMonth() {
        const today = new Date();
        const day = today.getDate();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).getDay();
        const adjustedDate = day + (firstDay === 0 ? 6 : firstDay - 1);
        return Math.ceil(adjustedDate / 7);
    }

    function goBack() {
        const user = JSON.parse(localStorage.getItem('tazkia_session'));
        if (user.role === 'admin') window.location.href = 'adminpantau.html';
        else if (user.role === 'pembina') window.location.href = 'dashboardpembina.html';
        else window.location.href = 'dashboardmahasiswa.html';
    }

    window.onload = async function() {
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('tazkia_session'));
        if (!token || !user) { window.location.href = "login.html"; return; }

        const urlParams = new URLSearchParams(window.location.search);
        const targetWeek = urlParams.get('week') || getWeekOfMonth(); 
        const targetNim = urlParams.get('nim') || String(user.nim);
        const targetNama = urlParams.get('nama') || (targetNim === String(user.nim) ? user.nama : "Mahasiswa");

        document.getElementById('studentName').innerText = targetNama + " | NIM: " + targetNim;
        document.getElementById('weekTitle').innerText = "Rekapan Minggu ke-" + targetWeek;

        // --- CEK ROLE UNTUK MENAMPILKAN SUMMARY ---
        if (user.role !== 'pembina') {
            const sumSection = document.getElementById('summarySection');
            const alrtBox = document.getElementById('alertBox');
            if(sumSection) sumSection.remove();
            if(alrtBox) alrtBox.remove();
        }

        loadData(targetNim, token, targetWeek);
    };

    async function loadData(nim, token, weekFilter) {
        try {
            const response = await fetch(`http://localhost:3000/api/evaluasi/stats?nim=${nim}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            const timeline = document.getElementById('timelineContent');
            timeline.innerHTML = '';

            let filteredData = data.filter(item => String(item.weekStart) === String(weekFilter));
            if (filteredData.length === 0) {
                timeline.innerHTML = '<div style="text-align:center; padding:40px; background:white; border-radius:15px; color:#888;">Belum ada laporan minggu ini.</div>';
                return;
            }

            const j = filteredData[0].jawaban || {};
            const activities = [
                { label: 'Tilawah Al-Qur\'an', val: j.tilawah, icon: 'fa-book-open', desc1: '< 4 Juz', desc2: '4-7 Juz', desc3: '> 7 Juz' },
                { label: 'Al-Matsurat', val: j.matsurot, icon: 'fa-pray', desc1: '< 3 Kali', desc2: '4-6 Kali', desc3: '> 7 Kali' },
                { label: 'Sholat di Masjid', val: j.sholatMasjid, icon: 'fa-mosque', desc1: '< 6 Kali', desc2: '7-20 Kali', desc3: '> 21 Kali' },
                { label: 'Sholat Malam', val: j.sholatMalam, icon: 'fa-moon', desc1: '< 1 Kali', desc2: '2 Kali', desc3: '> 3 Kali' },
                { label: 'Puasa Sunnah', val: j.puasa, icon: 'fa-utensils', desc1: '0 Kali', desc2: '1 Kali', desc3: '2 Kali' },
                { label: 'Olahraga', val: j.olahraga, icon: 'fa-running', desc1: '0 Kali', desc2: '1-2 Kali', desc3: '> 3 Kali' },
                { label: 'Kegiatan Keluarga', val: j.keluarga, icon: 'fa-users', desc1: '0 Kali', desc2: '1-3 Kali', desc3: '> 4 Kali' },
                { label: 'Infaq', val: j.infaq, icon: 'fa-hand-holding-heart', type: 'bool' },
                { label: 'Donasi Palestina', val: j.donasiPalestina, icon: 'fa-globe', type: 'bool' }
            ];

            // HITUNG RINGKASAN (Untuk Pembina)
            let totalSkor = 0;
            let amalanTerendah = [];
            activities.forEach(a => {
                let s = Number(a.val || 1);
                totalSkor += s;
                if (s === 1) amalanTerendah.push(a.label);
            });

            const summarySection = document.getElementById('summarySection');
            if (summarySection) {
                summarySection.style.display = 'grid';
                document.getElementById('totalScoreText').innerText = `${totalSkor}/27`;
                document.getElementById('percentText').innerText = `${Math.round((totalSkor/27)*100)}%`;
                document.getElementById('lowAmalanText').innerText = amalanTerendah.length > 0 ? amalanTerendah[0] : "Lengkap";
                
                if (amalanTerendah.length > 0) {
                    document.getElementById('alertBox').style.display = 'block';
                    document.getElementById('alertMessage').innerText = `Perlu bimbingan khusus pada: ${amalanTerendah.join(', ')}.`;
                }
            }

            // RENDER TIMELINE RAMPING
            activities.forEach(act => {
                const item = document.createElement('div');
                item.className = 'timeline-item';
                let s = Number(act.val || 1);
                let isYa = s === 3;
                let status = s === 3 ? "BAIK" : s === 2 ? "CUKUP" : "KURANG";
                let detail = act[`desc${s}`] || (isYa ? 'Sudah' : 'Belum');
                
                let badgeClass = act.type === 'bool' ? (isYa ? 'score-3' : 'score-1') : `score-${s}`;
                let badgeText = act.type === 'bool' ? (isYa ? 'YA' : 'TIDAK') : status;

                item.innerHTML = `
                    <div class="timeline-dot"></div>
                    <div class="timeline-card">
                        <div class="item-info">
                            <div class="item-icon"><i class="fas ${act.icon}"></i></div>
                            <h4 style="margin:0; font-size:13px;">${act.label}</h4>
                        </div>
                        <div class="score-display">
                            <span class="badge-score ${badgeClass}">${badgeText} (${s})</span>
                            <span class="score-desc">(${detail})</span>
                        </div>
                    </div>`;
                timeline.appendChild(item);
            });
        } catch (err) { console.error(err); }
    }
</script>
</body>
</html>